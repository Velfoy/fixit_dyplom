generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model branches {
  id         Int         @id @default(autoincrement())
  name       String      @db.VarChar(100)
  address    String      @db.VarChar(255)
  phone      String?     @db.VarChar(20)
  email      String?     @unique @db.VarChar(100)
  created_at DateTime    @default(now()) @db.Timestamp(6)
  updated_at DateTime    @default(now()) @db.Timestamp(6)
  employees  employees[]
  vehicle    vehicle[]
}

model customer {
  id            Int             @id @default(autoincrement())
  user_id       Int?            @unique
  address       String?         @db.VarChar(255)
  city          String?         @db.VarChar(100)
  postal_code   String?         @db.VarChar(20)
  nip           String?         @db.VarChar(20)
  created_at    DateTime        @default(now()) @db.Timestamp(6)
  updated_at    DateTime        @default(now()) @db.Timestamp(6)
  users         users?          @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  review        review[]
  service_order service_order[]
  vehicle       vehicle[]
}

model document {
  id                      Int                   @id @default(autoincrement())
  service_order_id        Int?
  service_task_id         Int?
  service_task_comment_id Int?
  type                    document_type
  url                     String
  filename                String?               @db.VarChar(255)
  filesize                Int?
  thumbnail_url           String?
  duration                Int?
  created_at              DateTime              @default(now()) @db.Timestamp(6)
  service_order           service_order?        @relation(fields: [service_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  service_task_comment    service_task_comment? @relation(fields: [service_task_comment_id], references: [id], onUpdate: NoAction)
  service_task            service_task?         @relation(fields: [service_task_id], references: [id], onUpdate: NoAction)

  @@index([service_order_id], map: "idx_document_order")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model employees {
  id                   Int                      @id @default(autoincrement())
  position             String?                  @db.VarChar(100)
  salary               Decimal?                 @db.Decimal(10, 2)
  branch_id            Int?
  created_at           DateTime                 @default(now()) @db.Timestamp(6)
  updated_at           DateTime                 @default(now()) @db.Timestamp(6)
  user_id              Int                      @unique
  hired_at             DateTime                 @default(dbgenerated("CURRENT_DATE")) @db.Date
  terminated_at        DateTime?                @db.Date
  employment_type      employee_employment_type @default(FULL_TIME)
  is_active            Boolean                  @default(true)
  specialization       String?
  extra                Json                     @default("{}")
  branches             branches?                @relation(fields: [branch_id], references: [id], onUpdate: NoAction)
  users                users                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  service_order        service_order[]
  service_task         service_task[]
  service_task_comment service_task_comment[]
}

model invoice {
  id               Int             @id @default(autoincrement())
  invoice_number   String          @unique @db.VarChar(50)
  service_order_id Int?            @unique
  issue_date       DateTime        @default(dbgenerated("CURRENT_DATE")) @db.Date
  due_date         DateTime?       @db.Date
  total_amount     Decimal         @db.Decimal(10, 2)
  tax_amount       Decimal         @db.Decimal(10, 2)
  pdf_url          String?
  created_at       DateTime        @default(now()) @db.Timestamp(6)
  status           invoice_status? @default(UNPAID)
  paid_at          DateTime?       @db.Timestamp(6)
  currency         String?         @default("USD") @db.VarChar(10)
  service_order    service_order?  @relation(fields: [service_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payment          payment[]
}

model logs {
  id          Int      @id @default(autoincrement())
  user_id     Int?
  action      String
  entity_type String?  @db.VarChar(50)
  entity_id   String?  @db.VarChar(50)
  created_at  DateTime @default(now()) @db.Timestamp(6)
  users       users?   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_logs_user")
}

model notification {
  id         Int               @id @default(autoincrement())
  user_id    Int?
  type       notification_type
  title      String            @db.VarChar(150)
  message    String?
  read       Boolean           @default(false)
  created_at DateTime          @default(now()) @db.Timestamp(6)
  users      users?            @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_notification_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model part {
  id                 Int                  @id @default(autoincrement())
  name               String               @db.VarChar(100)
  part_number        String               @unique @db.VarChar(50)
  quantity           Int                  @default(0)
  min_quantity       Int                  @default(5)
  price              Decimal              @db.Decimal(10, 2)
  supplier           String?              @db.VarChar(100)
  created_at         DateTime             @default(now()) @db.Timestamp(6)
  updated_at         DateTime             @default(now()) @db.Timestamp(6)
  service_order_part service_order_part[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model review {
  id               Int            @id @default(autoincrement())
  customer_id      Int?
  service_order_id Int?
  rating           Int
  comment          String?
  created_at       DateTime       @default(now()) @db.Timestamp(6)
  customer         customer?      @relation(fields: [customer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  service_order    service_order? @relation(fields: [service_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model service_order {
  id                           Int                            @id @default(autoincrement())
  order_number                 String                         @unique @db.VarChar(50)
  vehicle_id                   Int?
  customer_id                  Int?
  mechanic_id                  Int?
  description                  String?
  status                       order_status                   @default(NEW)
  is_status_manual             Boolean                        @default(false)
  start_date                   DateTime                       @default(now()) @db.Timestamp(6)
  end_date                     DateTime?                      @db.Timestamp(6)
  labor_cost                   Decimal                        @default(0) @db.Decimal(10, 2)
  total_cost                   Decimal                        @default(0) @db.Decimal(10, 2)
  notes                        String?
  created_at                   DateTime                       @default(now()) @db.Timestamp(6)
  updated_at                   DateTime                       @default(now()) @db.Timestamp(6)
  progress                     Decimal                        @default(0) @db.Decimal(5, 2)
  priority                     order_priority                 @default(NORMAL)
  issue                        String?
  document                     document[]
  invoice                      invoice?
  payment                      payment[]
  review                       review[]
  customer                     customer?                      @relation(fields: [customer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  employees                    employees?                     @relation(fields: [mechanic_id], references: [id], onUpdate: NoAction)
  vehicle                      vehicle?                       @relation(fields: [vehicle_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  service_order_item           service_order_item[]
  service_order_part           service_order_part[]
  service_order_status_history service_order_status_history[]
  service_task                 service_task[]

  @@index([customer_id], map: "idx_service_order_customer")
  @@index([mechanic_id], map: "idx_service_order_mechanic")
  @@index([status], map: "idx_service_order_status")
  @@index([vehicle_id], map: "idx_service_order_vehicle")
}

model service_order_part {
  id                  Int            @id @default(autoincrement())
  service_order_id    Int?
  part_id             Int?
  quantity            Int
  price_at_time       Decimal        @db.Decimal(10, 2)
  created_at          DateTime       @default(now()) @db.Timestamp(6)
  updated_at          DateTime       @default(now()) @db.Timestamp(6)
  deductFromWarehouse Boolean?       @default(false) @map("deduct_from_warehouse")
  warehouseDeductedAt DateTime?      @map("warehouse_deducted_at") @db.Timestamp(6)
  part                part?          @relation(fields: [part_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  service_order       service_order? @relation(fields: [service_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model service_order_status_history {
  id               Int            @id @default(autoincrement())
  service_order_id Int?
  old_status       order_status?
  new_status       order_status
  changed_by       Int?
  is_manual        Boolean        @default(false)
  note             String?
  created_at       DateTime       @default(now()) @db.Timestamp(6)
  users            users?         @relation(fields: [changed_by], references: [id], onUpdate: NoAction)
  service_order    service_order? @relation(fields: [service_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model service_task {
  id                   Int                    @id @default(autoincrement())
  service_order_id     Int?
  mechanic_id          Int?
  title                String                 @db.VarChar(150)
  description          String?
  created_at           DateTime               @default(now()) @db.Timestamp(6)
  updated_at           DateTime               @default(now()) @db.Timestamp(6)
  priority             order_priority         @default(NORMAL)
  status               order_status           @default(NEW)
  document             document[]
  employees            employees?             @relation(fields: [mechanic_id], references: [id], onUpdate: NoAction)
  service_order        service_order?         @relation(fields: [service_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  service_task_comment service_task_comment[]

  @@index([service_order_id], map: "idx_service_task_order")
}

model service_task_comment {
  id                 Int           @id @default(autoincrement())
  service_task_id    Int?
  mechanic_id        Int?
  title              String?       @db.VarChar(150)
  message            String?
  status             task_status?
  has_attachment     Boolean       @default(false)
  created_at         DateTime      @default(now()) @db.Timestamp(6)
  updated_at         DateTime      @default(now()) @db.Timestamp(6)
  created_by_user_id Int?
  document           document[]
  author             users?        @relation("service_task_comment_author", fields: [created_by_user_id], references: [id], onUpdate: NoAction, map: "service_task_comment_author_fkey")
  employees          employees?    @relation(fields: [mechanic_id], references: [id], onUpdate: NoAction)
  service_task       service_task? @relation(fields: [service_task_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_by_user_id], map: "idx_service_task_comment_author")
}

model users {
  id                           Int                            @id @default(autoincrement())
  email                        String                         @unique @db.VarChar(100)
  password                     String                         @db.VarChar(255)
  phone                        String?                        @db.VarChar(20)
  role                         user_role                      @default(CLIENT)
  created_at                   DateTime                       @default(now()) @db.Timestamp(6)
  updated_at                   DateTime                       @default(now()) @db.Timestamp(6)
  first_name                   String?                        @db.VarChar(100)
  last_name                    String?                        @db.VarChar(100)
  customer                     customer?
  employees                    employees?
  logs                         logs[]
  notification                 notification[]
  service_order_status_history service_order_status_history[]
  service_task_comment         service_task_comment[]         @relation("service_task_comment_author")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model vehicle {
  id                  Int             @id @default(autoincrement())
  customer_id         Int?
  brand               String          @db.VarChar(50)
  model               String          @db.VarChar(50)
  year                Int?
  vin                 String          @unique @db.VarChar(50)
  license_plate       String?         @db.VarChar(20)
  mileage             Int?
  next_inspection     DateTime?       @db.Date
  created_at          DateTime        @default(now()) @db.Timestamp(6)
  updated_at          DateTime        @default(now()) @db.Timestamp(6)
  fuel_type           String?         @db.VarChar(20)
  engine_size         String?         @db.VarChar(20)
  transmission        String?         @db.VarChar(20)
  body_type           String?         @db.VarChar(50)
  color               String?         @db.VarChar(30)
  last_service        DateTime?       @db.Date
  next_service        DateTime?       @db.Date
  service_interval_km Int?
  insurance_expiry    DateTime?       @db.Date
  status              String          @default("ACTIVE") @db.VarChar(20)
  branch_id           Int?
  service_order       service_order[]
  branches            branches?       @relation(fields: [branch_id], references: [id])
  customer            customer?       @relation(fields: [customer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model payment {
  id                      Int             @id @default(autoincrement())
  invoice_id              Int
  payment_provider        String?         @db.VarChar(50)
  provider_transaction_id String?         @db.VarChar(100)
  method                  String          @db.VarChar(50)
  status                  payment_status? @default(PENDING)
  amount                  Decimal         @db.Decimal(10, 2)
  tax_paid                Decimal?        @db.Decimal(10, 2)
  fee                     Decimal?        @db.Decimal(10, 2)
  net_amount              Decimal?        @db.Decimal(10, 2)
  currency                String?         @default("USD") @db.VarChar(10)
  card_brand              String?         @db.VarChar(20)
  card_last4              String?         @db.Char(4)
  receipt_url             String?
  created_at              DateTime?       @default(now()) @db.Timestamp(6)
  completed_at            DateTime?       @db.Timestamp(6)
  refunded_at             DateTime?       @db.Timestamp(6)
  service_order_id        Int?
  invoice                 invoice         @relation(fields: [invoice_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  service_order           service_order?  @relation(fields: [service_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model service_order_item {
  id               Int           @id @default(autoincrement())
  service_order_id Int
  name             String        @db.VarChar(100)
  type             String        @db.VarChar(50)
  cost             Decimal       @db.Decimal(10, 2)
  status           String?       @default("pending") @db.VarChar(20)
  created_at       DateTime?     @default(now()) @db.Timestamp(6)
  service_order    service_order @relation(fields: [service_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

enum document_type {
  PHOTO
  VIDEO
  INVOICE
  DOCUMENT
}

enum notification_type {
  REPAIR_COMPLETED
  INSPECTION_SOON
  PROMOTION
  MESSAGE
}

enum order_status {
  NEW
  IN_PROGRESS
  WAITING_FOR_PARTS
  READY
  COMPLETED
  CANCELLED
}

enum task_status {
  PENDING
  IN_PROGRESS
  DONE
  BLOCKED
}

enum user_role {
  ADMIN
  MECHANIC
  WAREHOUSE
  RECEPTIONIST
  CLIENT
}

enum employee_employment_type {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
}

enum order_priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum invoice_status {
  UNPAID
  PAID
  OVERDUE
  CANCELED
  REFUNDED
}

enum payment_status {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  PARTIAL
}
